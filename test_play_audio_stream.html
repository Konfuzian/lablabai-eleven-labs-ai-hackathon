<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Playing audio with streaming turned on</title>
</head>
<body>
	<section data-player>
		<select data-player-voices><!-- options will be populated on load --></select>
		<textarea data-player-text multiline columns="10" placeholder="Insert a text here"></textarea><br />
		<button data-player-play type="button">Play text</button><br />
		<audio data-player-output controls></audio>
	</div>

	<script type="text/javascript">

		// we use objects to simulate named parameters as in https://masteringjs.io/tutorials/fundamentals/parameters

		const 
		getOptions = ({ text = '', model_id = "eleven_monolingual_v1", stability = 0.5, similarity_boost = 0.5 } = {}) => ({
			method: 'POST',
			body: JSON.stringify({
				text: text,
				model_id: model_id,
				voice_settings: {
					stability: stability,
					similarity_boost: similarity_boost
				}
			}),
			headers: {
				"Content-Type": "application/json",
				"xi-api-key": "a5c043e13ce68da1077daa5cb776c59b"
			}
		}),

		getUrl = ({ voice_id = '21m00Tcm4TlvDq8ikWAM' } = {}) => `https://api.elevenlabs.io/v1/text-to-speech/${voice_id}/stream`,

		fetchAndPlayAudio = ({
			text = undefined,
			output = undefined,
			voice_id = '21m00Tcm4TlvDq8ikWAM',
			model_id = "eleven_monolingual_v1",
			stability = 0.5,
			similarity_boost = 0.5
		} = {}) => {
			if (text === undefined || output === undefined) return;  // this should never happen
			fetch(
				getUrl({ voice_id: voice_id }),
				getOptions({text: text, model_id: model_id, stability: stability, similarity_boost: similarity_boost}))
			  .then(response => response.blob())
			  .then(blob => {
			    output.src = window.URL.createObjectURL(blob);
			    output.play();
			  })
			  .catch(error => console.error(error));
		},

		setupPlayer = () => document.querySelectorAll("[data-player]").forEach(el => {
			const 
			play = el.querySelector("[data-player-play]"),
			voices = el.querySelector("[data-player-voices]"),
			text = el.querySelector("[data-player-text]"),
			output = el.querySelector("[data-player-output]");

			play.addEventListener("click", e => {
				fetchAndPlayAudio({
					text: text.value,
					output: output,
					voice_id: '21m00Tcm4TlvDq8ikWAM'
				});
			})
		}),

		// actual setup is here:
		setupPlayer();

	</script>

</body>
</html>
